<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Chart</title>
    
    <!-- 1. LOAD LIBRARY FROM CDN (No local file needed) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        /* CSS STYLES */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            height: 50px;
            background-color: #222;
            border-bottom: 1px solid #333;
            box-sizing: border-box;
        }

        .token-info {
            display: flex;
            align-items: center;
        }

        #tokenIcon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background-color: #333; /* Placeholder circle */
        }

        .text-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #tokenSymbol {
            font-weight: 700;
            font-size: 14px;
            line-height: 1.1;
            text-transform: uppercase;
        }

        #tokenPrice {
            font-size: 12px;
            color: #00ff88;
            margin-top: 2px;
        }

        #chartContainer {
            width: 100%;
            height: calc(100% - 50px);
            position: relative;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="token-info">
            <img id="tokenIcon" src="https://i.imgur.com/vLda3fU.png" alt="Icon" onerror="this.src='https://i.imgur.com/vLda3fU.png';">
            <div class="text-group">
                <span id="tokenSymbol">LOADING...</span>
                <span id="tokenPrice">$--.--</span>
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div id="chartContainer"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // 1. Configuration
        const COIN_MAP = {
            'BTC': 'bitcoin',
            'ETH': 'ethereum',
            'USDT': 'tether',
            'SOL': 'solana',
            'XRP': 'ripple',
            'ADA': 'cardano',
            'DOGE': 'dogecoin',
            'BNB': 'binancecoin',
            'USDC': 'usd-coin'
        };

        // 2. Get Symbol from URL
        const urlParams = new URLSearchParams(window.location.search);
        const symbolRaw = urlParams.get('symbol') || 'BTC';
        const symbol = symbolRaw.toUpperCase();
        const coinId = COIN_MAP[symbol] || symbol.toLowerCase();

        // 3. Setup UI
        const iconEl = document.getElementById('tokenIcon');
        const symbolEl = document.getElementById('tokenSymbol');
        const priceEl = document.getElementById('tokenPrice');
        const container = document.getElementById('chartContainer');

        // Update Header immediately
        symbolEl.innerText = symbol;
        iconEl.src = `https://assets.coincap.io/assets/icons/${symbol.toLowerCase()}@2x.png`;

        // 4. Create Chart
        const chart = LightweightCharts.createChart(container, {
            layout: {
                background: { color: '#1a1a1a' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2B2B43' },
                horzLines: { color: '#2B2B43' },
            },
            width: container.clientWidth,
            height: container.clientHeight,
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const areaSeries = chart.addAreaSeries({
            lineColor: '#2962FF',
            topColor: '#2962FF',
            bottomColor: 'rgba(41, 98, 255, 0.28)',
        });

        // Resize logic
        window.addEventListener('resize', () => {
            chart.resize(container.clientWidth, container.clientHeight);
        });

        // 5. Fetch Data
        async function loadData() {
            try {
                // Fetch CoinGecko Data
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=1`);
                
                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                
                // Format Data
                const chartData = data.prices.map(item => ({
                    time: item[0] / 1000,
                    value: item[1]
                }));

                // Update Chart
                areaSeries.setData(chartData);
                chart.timeScale().fitContent();

                // Update Price
                const lastPrice = chartData[chartData.length - 1].value;
                priceEl.innerText = `$${lastPrice.toFixed(2)}`;

            } catch (error) {
                console.error("Chart Error:", error);
                priceEl.innerText = "Error";
                priceEl.style.color = "#ff4444";
            }
        }

        // Start
        loadData();
    </script>
</body>
</html>
