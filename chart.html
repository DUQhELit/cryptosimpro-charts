<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Chart</title>
    
    <!-- 1. LOAD LIBRARY FROM CDN -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
            overflow: hidden;
        }

        /* Flex Container to center chart vertically if needed */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            height: 50px;
            background-color: #222;
            border-bottom: 1px solid #333;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .token-info {
            display: flex;
            align-items: center;
        }

        #tokenIcon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background-color: #333;
        }

        .text-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #tokenSymbol {
            font-weight: 700;
            font-size: 14px;
            line-height: 1.1;
            text-transform: uppercase;
        }

        #tokenPrice {
            font-size: 12px;
            color: #00ff88;
            margin-top: 2px;
        }

        #chartContainer {
            width: 100%;
            flex-grow: 1; /* Fills remaining space */
            position: relative;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="token-info">
                <img id="tokenIcon" src="https://i.imgur.com/vLda3fU.png" alt="Icon" onerror="this.src='https://i.imgur.com/vLda3fU.png';">
                <div class="text-group">
                    <span id="tokenSymbol">LOADING...</span>
                    <span id="tokenPrice">$--.--</span>
                </div>
            </div>
        </div>

        <!-- CHART -->
        <div id="chartContainer"></div>
    </div>

    <script>
        // 1. Get Symbol from URL (Default to BTC)
        const urlParams = new URLSearchParams(window.location.search);
        const symbolRaw = urlParams.get('symbol') || 'BTC';
        const symbol = symbolRaw.toUpperCase();

        // 2. Setup UI Elements
        const iconEl = document.getElementById('tokenIcon');
        const symbolEl = document.getElementById('tokenSymbol');
        const priceEl = document.getElementById('tokenPrice');
        const container = document.getElementById('chartContainer');

        // Update Header Immediately
        symbolEl.innerText = symbol;
        // Use CoinCap CDN for images (Safe & Reliable)
        iconEl.src = `https://assets.coincap.io/assets/icons/${symbol.toLowerCase()}@2x.png`;

        // 3. Create Chart
        const chart = LightweightCharts.createChart(container, {
            layout: {
                background: { color: '#1a1a1a' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { visible: false },
                horzLines: { color: '#2B2B43', style: 2 }, // Dotted lines
            },
            rightPriceScale: {
                borderVisible: false,
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
                borderVisible: false,
            },
            crosshair: {
                vertLine: { labelVisible: false },
            },
        });

        // Add Blue Area Series (Like Robinhood/Coinbase style)
        const areaSeries = chart.addAreaSeries({
            lineColor: '#2962FF',
            topColor: 'rgba(41, 98, 255, 0.4)',
            bottomColor: 'rgba(41, 98, 255, 0.0)',
            lineWidth: 2,
        });

        // Auto-Resize Logic
        const resizeObserver = new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== container) { return; }
            const newRect = entries[0].contentRect;
            chart.applyOptions({ width: newRect.width, height: newRect.height });
        });
        resizeObserver.observe(container);

        // 4. DATA FETCHING (Using Binance API)
        async function loadData() {
            try {
                // Construct Binance Pair (e.g., BTC -> BTCUSDT)
                // Handle generic cases. If USDT, map to USDC for stability.
                let pair = symbol === 'USDT' ? 'USDCUSDT' : symbol + 'USDT';
                
                // Fetch 1 Hour candles, limit 24 (Last 24 hours)
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=1h&limit=24`);
                
                if (!response.ok) throw new Error("Binance API Error");

                const rawData = await response.json();

                // Binance format: [openTime, open, high, low, close, volume, ...]
                const chartData = rawData.map(d => ({
                    time: d[0] / 1000,       // Convert ms to seconds
                    value: parseFloat(d[4])  // Close price
                }));

                // Update Chart
                areaSeries.setData(chartData);
                chart.timeScale().fitContent();

                // Update Price Text
                const lastPrice = chartData[chartData.length - 1].value;
                // Smart formatting: if price < 1 show 4 decimals, else 2
                const decimals = lastPrice < 1.0 ? 4 : 2;
                priceEl.innerText = `$${lastPrice.toFixed(decimals)}`;

            } catch (error) {
                console.error("Data Load Failed:", error);
                // Try fallback color to indicate issue
                priceEl.innerText = "N/A";
                priceEl.style.color = "orange";
            }
        }

        // Run
        loadData();
    </script>
</body>
</html>
