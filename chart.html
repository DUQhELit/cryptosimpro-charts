<script>
    // 1) Symbol from URL (default BTC)
    const urlParams = new URLSearchParams(window.location.search);
    const symbolRaw = urlParams.get('symbol') || 'BTC';
    const symbol = symbolRaw.toUpperCase();

    // 2) UI elements
    const iconEl = document.getElementById('tokenIcon');
    const symbolEl = document.getElementById('tokenSymbol');
    const priceEl = document.getElementById('tokenPrice');
    const container = document.getElementById('chartContainer');

    symbolEl.innerText = symbol;
    iconEl.src = `https://assets.coincap.io/assets/icons/${symbol.toLowerCase()}@2x.png`;

    // 3) Chart (white background, green line/fill)
    const chart = LightweightCharts.createChart(container, {
        layout: {
            background: { color: '#ffffff' },
            textColor: '#222222',
        },
        grid: {
            vertLines: { visible: false },
            horzLines: { color: '#e6e6e6', style: 1 },
        },
        rightPriceScale: { borderVisible: false },
        timeScale: { timeVisible: true, secondsVisible: false, borderVisible: false },
        crosshair: { vertLine: { labelVisible: false } },
    });

    const areaSeries = chart.addAreaSeries({
        lineColor: '#00C853',                    // green line
        topColor: 'rgba(0, 200, 83, 0.35)',      // green fill
        bottomColor: 'rgba(0, 200, 83, 0.00)',
        lineWidth: 2,
    });

    const resizeObserver = new ResizeObserver(entries => {
        if (!entries.length || entries[0].target !== container) return;
        const { width, height } = entries[0].contentRect;
        chart.applyOptions({ width, height });
    });
    resizeObserver.observe(container);

    // 4) Data fetch via your PHP proxy
    async function loadData() {
        try {
            const PHP_PROXY_URL = "https://tradesimulator.io/api/chart-proxy.php"; // your proxy
            const response = await fetch(`${PHP_PROXY_URL}?symbol=${symbol}`);
            if (!response.ok) throw new Error(`Proxy Error: ${response.status}`);

            const rawData = await response.json();

            if (rawData.Response === 'Error') {
                throw new Error(`CryptoCompare API Error: ${rawData.Message}`);
            }

            // Handle both shapes: Data.Data (CryptoCompare raw) or Data (array)
            const rows = (rawData.Data && rawData.Data.Data) ? rawData.Data.Data :
                         Array.isArray(rawData.Data) ? rawData.Data : [];
            const chartData = rows.map(d => ({ time: d.time, value: d.close }));

            areaSeries.setData(chartData);
            chart.timeScale().fitContent();

            const lastPrice = chartData.length ? chartData[chartData.length - 1].value : 0;
            const decimals = lastPrice < 1 ? 4 : 2;
            priceEl.innerText = `$${lastPrice.toFixed(decimals)}`;
            priceEl.style.color = '#00C853';
        } catch (err) {
            console.error("Data Load Failed:", err);
            priceEl.innerText = "N/A";
            priceEl.style.color = "orange";
        }
    }

    loadData();
</script>
